{"version":3,"file":"oauth2.base.esm.js","sources":["../../src/providers/oauth2.base.ts"],"sourcesContent":["import { Provider } from \"./base\";\nexport class OAuth2BaseProvider extends Provider {\n    async signin(event, auth) {\n        const { method } = event.request;\n        const { url } = event;\n        const state = [\n            `redirect=${url.searchParams.get(\"redirect\") ?? this.getUri(auth, \"/\", url.host)}`,\n        ].join(\",\");\n        const base64State = Buffer.from(state).toString(\"base64\");\n        const nonce = Math.round(Math.random() * 1000).toString();\n        const authUrl = await this.getAuthorizationUrl(event, auth, base64State, nonce);\n        if (method === \"POST\") {\n            return {\n                body: {\n                    redirect: authUrl,\n                },\n            };\n        }\n        return {\n            status: 302,\n            headers: {\n                Location: authUrl,\n            },\n        };\n    }\n    getStateValue(query, name) {\n        if (query.get(\"state\")) {\n            const state = Buffer.from(query.get(\"state\"), \"base64\").toString();\n            return state\n                .split(\",\")\n                .find((state) => state.startsWith(`${name}=`))\n                ?.replace(`${name}=`, \"\");\n        }\n    }\n    async callback(event, auth) {\n        const { request, url } = event;\n        const code = url.searchParams.get(\"code\");\n        const redirect = this.getStateValue(url.searchParams, \"redirect\");\n        const tokens = await this.getTokens(code, this.getCallbackUri(auth, url.host));\n        let user = await this.getUserProfile(tokens);\n        if (this.config.profile) {\n            user = await this.config.profile(user, tokens);\n        }\n        return [user, redirect ?? this.getUri(auth, \"/\", url.host)];\n    }\n}\n"],"names":[],"mappings":";;iCACwC,SAAS;AAAA,QACvC,OAAO,OAAO,MAAM;AACtB,UAAM,EAAE,WAAW,MAAM;AACzB,UAAM,EAAE,QAAQ;AAChB,UAAM,QAAQ;AAAA,MACV,YAAY,IAAI,aAAa,IAAI,eAAe,KAAK,OAAO,MAAM,KAAK,IAAI;AAAA,MAC7E,KAAK;AACP,UAAM,cAAc,OAAO,KAAK,OAAO,SAAS;AAChD,UAAM,QAAQ,KAAK,MAAM,KAAK,WAAW,KAAM;AAC/C,UAAM,UAAU,MAAM,KAAK,oBAAoB,OAAO,MAAM,aAAa;AACzE,QAAI,WAAW,QAAQ;AACnB,aAAO;AAAA,QACH,MAAM;AAAA,UACF,UAAU;AAAA;AAAA;AAAA;AAItB,WAAO;AAAA,MACH,QAAQ;AAAA,MACR,SAAS;AAAA,QACL,UAAU;AAAA;AAAA;AAAA;AAAA,EAItB,cAAc,OAAO,MAAM;AACvB,QAAI,MAAM,IAAI,UAAU;AACpB,YAAM,QAAQ,OAAO,KAAK,MAAM,IAAI,UAAU,UAAU;AACxD,aAAO,MACF,MAAM,KACN,KAAK,CAAC,WAAU,OAAM,WAAW,GAAG,WACnC,QAAQ,GAAG,SAAS;AAAA;AAAA;AAAA,QAG5B,SAAS,OAAO,MAAM;AACxB,UAAM,EAAE,SAAS,QAAQ;AACzB,UAAM,OAAO,IAAI,aAAa,IAAI;AAClC,UAAM,WAAW,KAAK,cAAc,IAAI,cAAc;AACtD,UAAM,SAAS,MAAM,KAAK,UAAU,MAAM,KAAK,eAAe,MAAM,IAAI;AACxE,QAAI,OAAO,MAAM,KAAK,eAAe;AACrC,QAAI,KAAK,OAAO,SAAS;AACrB,aAAO,MAAM,KAAK,OAAO,QAAQ,MAAM;AAAA;AAE3C,WAAO,CAAC,MAAM,YAAY,KAAK,OAAO,MAAM,KAAK,IAAI;AAAA;AAAA;;;;"}